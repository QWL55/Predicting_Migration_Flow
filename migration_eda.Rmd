---
title: "Migration Data EDA"
author: "Qiwei Lin"
date: "2024-10-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
```

```{r}
migration <- read_csv("bilat_mig.csv")
migration_type <- read_csv("bilat_mig_type.csv")
```

```{r}
migration %>% 
  group_by(year0) %>% 
  select(orig, dest, da_pb_closed) %>% 
  filter(da_pb_closed > 10) %>% 
  summarize(
    n_edges = n(),
    mean_flow = median(da_pb_closed)
  )
```

# County-to-County

```{r}


# Function to clean and extract data from each sheet
process_sheet <- function(sheet_name, file_path) {
  # Read the sheet and skip the first 2 rows to get actual data
  df <- read_excel(file_path, sheet = sheet_name, skip = 2)
  
  # Clean up column names
  colnames(df) <- c("state_code_a", "fips_county_a", "state_code_b", "fips_county_b", 
                    "state_name_a", "county_name_a", "state_name_b", "county_name_b", 
                    "flow_b_to_a_estimate", "flow_b_to_a_moe", "flow_a_to_b_estimate", 
                    "flow_a_to_b_moe", "net_migration_estimate", "net_migration_moe", 
                    "gross_migration_estimate", "gross_migration_moe")
  
  # Filter out rows with missing values in essential columns
  df <- df %>%
    filter(!is.na(fips_county_a) & !is.na(fips_county_b)) %>%
    select(state_name_a, county_name_a, state_name_b, county_name_b, 
           flow_b_to_a_estimate, flow_a_to_b_estimate, net_migration_estimate, gross_migration_estimate)
  
  return(df)
}
```

```{r}
# Get the list of sheets (each representing a state)
file_path <- "county-to-county-2016-2020-ins-outs-nets-gross.xlsx"
sheets <- excel_sheets(file_path)

# Apply the process_sheet function to each sheet and combine the results into one dataframe
migration_data <- map_dfr(sheets, ~process_sheet(.x, file_path))
```

```{r}
migration_data %>% 
  filter(flow_b_to_a_estimate >= 10 | flow_a_to_b_estimate >= 10) %>% 
  select(1:6) %>% 
  pivot_longer(cols = contains("flow"), names_to = "estimate") %>%
  filter(value > 10) %>% 
  summarize(
    mean_flow = median(value)
  )
```
# Calculate Network Statistics 
